BUI.use(["bui/menu","bui/tab"],function(a,b){function o(a){window.topManager=a}function p(a,b){return-1!==a.indexOf("?")?a+"&"+b:a+"?"+b}function q(c,d,e,f,g){var h=this,l=new a.SideMenu(e),m=new b.NavTab(d),n=$(e.render),o=n.next("."+i+"-con"),p=n.parents("."+j);o&&(o.on("click",function(){p.toggleClass(k)}),o.parent().height(d.height)),f&&p.addClass(k),l.on("menuclick",function(a){var b=a.item;b&&h.tab.addTab({id:b.get("id"),title:b.get("text"),href:b.get("href"),closeable:b.get("closeable")},!0)}),l.on("itemselected",function(a){var b=a.item;b&&r(c,b.get("id"))}),m.on("activeChange",function(a){var b=a.item;b?h.menu.setSelectedByField(b.get("id")):h.menu.clearSelection()}),h.tab=m,h.menu=l,h.homePage=g,m.render(),l.render()}function r(a,b){b=b||"";var c="#"+a;b&&(c+="/"+b),location.hash=c}function s(){var a=location.hash,b=0,c="",d=a.indexOf("/"),e=null;return a?(d>=0?(b=a.substring(1,d),c=a.substring(d+1),e=t(c),e&&(c=c.replace("?"+e,""))):b=a.substring(1),{moduleId:b,pageId:c,search:e}):null}function t(a){var b=a.indexOf("?");return b>=0?a.substring(b+1):null}function u(a){if($.isArray(a)){for(var b=v(a);-1!==b;)a.splice(b,1),b=v(a);return a}}function v(a){var b=-1;return $.each(a,function(a,c){return null===c||void 0===c?(b=a,!1):void 0}),b}function w(){var a=BUI.viewportHeight(),b=61;return a-b}function x(a){var b=$(a);return b.hasClass(h)?a:b.parent("."+h)[0]}var c=BUI.app("PageUtil"),d="dl-selected",e="ks-hidden",f="dl-last",g="dl-hover",h="nav-item",i="dl-second-slib",j="dl-tab-item",k="dl-collapse",l="dl-hide-current",m="data-index",y=function(a){u(a),y.superclass.constructor.call(this,a),this._init(),o(this)};y.ATTRS={currentModelIndex:{},hideItmes:{value:[]},hideList:{},modules:{value:[]},modulesConfig:{},navList:{valueFn:function(){return $("#J_Nav")}},navContent:{valueFn:function(){return $("#J_NavContent")}},navItems:{valueFn:function(){return $("#J_Nav").children("."+h)}},navTabs:{valueFn:function(){return this.get("navContent").children("."+j)}},urlSuffix:{value:".html"}},BUI.extend(y,BUI.Base),BUI.augment(y,{openPage:function(a){var l,m,n,o,p,q,b=this,c=a.moduleId||b._getCurrentModuleId(),d=a.id,e=a.title||"新的标签页",f=a.href,g=a.isClose,h=a.closeable,i=a.reload,j=a.search,k=b._getModule(c);k&&(l=k.tab,m=k.menu,n=m.getItem(d),o=l.getActivedItem(),p=o?o.get("id"):null,q=b._getModuleIndex(c),c!=b._getCurrentModuleId()&&b._setModuleSelected(q),n?b._setPageSelected(q,d,i,j):l.addTab({id:d,title:e,href:f,sourceId:p,closeable:h},i),g&&o.close())},closePage:function(a,b){this.operatePage(b,a,"close")},reloadPage:function(a,b){this.operatePage(b,a,"reload")},setPageTitle:function(a,b,c){this.operatePage(c,b,"setTitle",[a])},operatePage:function(a,b,c,d){var e,f,g,h;a=a||this._getCurrentModuleId(),d=d||[],e=this,f=e._getModule(a),f&&(g=f.tab,h=b?g.getItemById(b):g.getActivedItem(),h&&h[c]&&h[c].apply(h,d))},_createModule:function(a){var e,f,b=this,c=b._getModuleConfig(a),d=b.get("modules");return c?(a=c.id,e="#J_"+a+"Tab",f="#J_"+a+"Tree",module=new q(a,{render:e,height:w()-10},{render:f,items:c.menu,height:w()},c.collapsed,c.homePage),d[a]=module,module):null},_hideHideList:function(){this.get("hideList").hide()},_init:function(){var a=this;a._initDom(),a._initNavItems(),a._initEvent()},_initNavItems:function(){var d,g,i,j,k,l,o,p,a=this,b=a.get("navItems"),c=a.get("hideItmes");if(0!==b.length&&($('<div class="nav-item-mask"></div>').appendTo($(b)),d=b.length,g=$(".dl-main-nav").width(),i=0,j=0,b.each(function(a,b){i+=$(b).outerWidth(!0),g>i+15&&j++}),!(g>=i))){for($.each(b,function(a,b){$(b).attr(m,a),$(b).removeClass(f)}),k=b[j-1],a._setLastItem(k),c.push($(k).clone()[0]),l=j;d>l;l++)o=$(b[l]),p=null,p=o.clone()[0],c.push(p),o.addClass(e);a._initHideList()}},_initHideList:function(){var d,e,a=this,b=a.get("hideList"),c=a.get("hideItmes");b||(d='<ul class="dl-hide-list ks-hidden"></ul>',e=$(d).appendTo("body"),b=e,$.each(c,function(a,c){$(c).appendTo(b)}),a.set("hideList",b),a._initHideListEvent())},_initHideListEvent:function(){var a=this,b=a.get("hideList");null!=b&&(b.on("mouseleave",function(){a._hideHideList()}),b.on("click",function(b){var c=x(b.target),d=null,e=0;c&&(d=$(c),e=d.attr(m),a._setModuleSelected(e),a._hideHideList())}))},_initContents:function(){var a=this,b=a.get("modulesConfig"),c=a.get("navContent");c.children().remove(),$.each(b,function(a,b){var d=b.id,e=['<li class="dl-tab-item ks-hidden"><div class="dl-second-nav"><div class="dl-second-tree" id="J_',d,'Tree"></div><div class="',i,'-con"><div class="',i,'"></div></div></div><div class="dl-inner-tab" id="J_',d,'Tab"></div></li>'].join("");new $(e).appendTo(c)})},_initDom:function(){var a=this;a._initContents(),a._initLocation()},_initEvent:function(){var a=this,b=a.get("navItems");b.each(function(b,c){var c=$(c);c.on("click",function(){var c=$(this);c.hasClass(d)||a._setModuleSelected(b,c)}).on("mouseenter",function(){$(this).addClass(g)}).on("mouseleave",function(){$(this).removeClass(g)})}),a._initNavListEvent()},_initNavListEvent:function(){var a=this,b=a.get("hideList"),c=a.get("navList");c.on("mouseover",function(c){var d=x(c.target),e=$(d),g=null;e&&e.hasClass(f)&&b&&(g=e.offset(),g.top+=e.height(),a._showHideList(g))}).on("mouseout",function(c){var d=c.toElement;d&&b&&!$.contains(b[0],d)&&d!==b[0]&&a._hideHideList()})},_initLocation:function(){var c,d,e,f,g,a=this,b=s();b?(c=b.pageId,d=b.search,e=a._getModuleIndex(b.moduleId),a._setModuleSelected(e),a._setPageSelected(e,c,!0,d)):(f=a.get("currentModelIndex"),g=a._getModuleId(f),null==f?a._setModuleSelected(0):r(g))},_getModule:function(a){var b=this,c=b.get("modules")[a];return c||(c=b._createModule(a)),c},_getModuleIndex:function(a){var b=this,c=0;return $.each(b.get("modulesConfig"),function(b,d){return d.id===a?(c=b,!1):void 0}),c},_getModuleConfig:function(a){var b=this,c=null;return $.each(b.get("modulesConfig"),function(b,d){return d.id===a?(c=d,!1):void 0}),c},_getModuleId:function(a){var b=this.get("modulesConfig");return b[a]?b[a].id:a},_getCurrentPageId:function(){var e,a=this,b=a._getCurrentModuleId(),c=a._getModule(b),d="";return c&&(e=c.menu.getSelected(),e&&(d=e.get("id"))),d},_getCurrentModuleId:function(){return this._getModuleId(this.get("currentModelIndex"))},_isModuleInitial:function(a){return!!this.get("modules")[a]},_setLastItem:function(a){var d,g,b=this,c=b.get("lastShowItem");c!==a&&(d=null,g=$(c),itemEl=$(a),c&&(d=g.find("."+l),g.removeClass(f),g.addClass(e)),itemEl.addClass(f),itemEl.removeClass(e),d||(d=$('<span class="nav-item-more '+l+'">&nbsp;&nbsp;</span>')),d.appendTo(itemEl.children(".nav-item-inner")),b.set("lastShowItem",a))},_setModuleSelected:function(a,b){var i,j,k,l,c=this,f=c.get("navItems"),g=c.get("navTabs"),h=c.get("currentModelIndex");h!==a&&(i=c._getModuleId(a),j=null,k=c.get("lastShowItem"),l=!0,c._isModuleInitial(i)||(l=!1),j=c._getModule(i),b=b||$(c.get("navItems")[a]),b.hasClass(e)&&k&&(c._setLastItem(b[0]),c._setSelectHideItem(a)),f.removeClass(d),b.addClass(d),g.addClass(e),$(g[a]).removeClass(e),h=a,c.set("currentModelIndex",h),curPageId=c._getCurrentPageId(),r(i,curPageId),!curPageId&&j.homePage&&c._setPageSelected(a,j.homePage))},_setPageSelected:function(a,b,c,d){var h,i,j,k,l,e=this,f=e._getModuleId(a)||a,g=e._getModule(f);g&&b&&(g.menu.setSelectedByField(b),h=g.menu.getSelected(),i=g.tab,j="",k=-1,h&&h.get("id")===b?(j=h.get("href"),j=d?p(j,d):j,g.tab.addTab({id:h.get("id"),title:h.get("text"),closeable:h.get("closeable"),href:j},!!c)):b&&(l=b.replace("-","/"),-1===l.indexOf("/")&&(l=f+"/"+l),-1===(k=b.indexOf("."))&&(l+=e.get("urlSuffix")),j=d?l+"?"+d:l,i.addTab({id:b,title:"",href:j},!!c)))},_showHideList:function(a){var b=this,c=b.get("hideList");c.css("left",a.left),c.css("top",a.top),c.show()},_setSelectHideItem:function(a){var b=this,c=b.get("hideList"),d=b.get("hideItmes"),e=null,g=null,h=null,i=null;BUI.each(d,function(b){var c=$(b);c.attr(m)==a&&(g=b),c.hasClass(f)&&(e=b)}),e!==g&&(e&&(i=$(e).find(".dl-hide-current"),$(e).removeClass(f)),$(g).addClass(f),i||(i=new Node('<span class="dl-hide-current">&nbsp;&nbsp;</span>')),h=$(g),i.appendTo(h.children(".nav-item-inner")),h.prependTo(c))}}),c.MainPage=y});